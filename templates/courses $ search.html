{% extends "courses.html" %}

{% block title %}
    Поиск курсов
{% endblock %}

{% block secondary_block %}
    {{ super() }}
    <div class="card mt-3">
        <h6 class="text-center">Расширенный поиск</h6>
        <form id="advanced-search-courses-form" autocomplete=off>
            {{ advanced_search_form.hidden_tag() }}
            <div class="form-group">
                {{advanced_search_form.advanced_title(class="form-control", placeholder="Название")}}
            </div>
            <div class="form-group">
                {{advanced_search_form.advanced_course_id(class="form-control", placeholder="ID курса")}}
            </div>
            <div class="submit-block">
                {{advanced_search_form.advanced_submit(type="submit", class="btn btn-secondary btn-block", onclick="searchCourse('advanced')")}}
            </div>
        </form>
    </div>
{% endblock %}

{% block main_block %}
    <form id="simple-search-courses-form" autocomplete=off class="w-100">
        {{ simple_search_form.hidden_tag() }}
        <div class="d-flex w-100">
            <div class="w-100 mr-2">
                {{simple_search_form.request(class="form-control border border-dark", placeholder="Введите запрос")}}
            </div>
            <div>{{simple_search_form.submit(type="submit", class="btn btn-dark my-2 my-sm-0", onclick="searchCourse('simple')")}}</div>
        </div>
    </form>
    <div class="mt-3" id="search-result">
    </div>
{% endblock %}

{% block script %}
<script>
    function searchCourse(type_of_search) {
        let xhr = new XMLHttpRequest();
        let data = {type_of_search: type_of_search,
                    request: document.getElementById("request").value,
                    title: document.getElementById("advanced_title").value,
                    course_id: document.getElementById("advanced_course_id").value};
        xhr.open('POST', '{{url_for('search_course')}}', true);
        xhr.onload = function() {
            let div = document.getElementById("search-result");
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }
            if (xhr.status == 200) {
                let data = JSON.parse(xhr.responseText);
                if (data["courses"].length == 0) {
                    let card = document.createElement('div');
                    card.className = "card d-flex justify-content-center align-items-center";
                    card.textContent = "По Вашему запросу ничего не найдено";
                    div.append(card);
                }
                for (let i = 0; i < data["courses"].length; i++) {
                    let course_card = document.createElement('div');
                    course_card.className = "alert card";
                    let course_card_content = document.createElement('div');
                    course_card_content.className = "d-flex";
                    let course_photo_block = document.createElement('div');
                    course_photo_block.className = "mr-2";
                    let course_photo = document.createElement('img');
                    course_photo.src = data["courses"][i]["profile_photo_url"];
                    course_photo.className = "sm-rounded-circle";
                    course_photo_block.append(course_photo);
                    let course_info_block = document.createElement('div');
                    course_info_block.className = "w-100";
                    let course_profile_link = document.createElement('a');
                    course_profile_link.className = "text-decoration-none text-dark";
                    course_profile_link.href = data["courses"][i]["profile_url"];
                    let course_name = document.createElement('h5');
                    course_name.textContent = data["courses"][i]["name"];
                    course_profile_link.append(course_name);
                    course_info_block.append(course_profile_link);
                    course_card_content.append(course_photo_block);
                    course_card_content.append(course_info_block);
                    course_card.append(course_card_content);
                    div.append(course_card);
                }
            } else {
                let card = document.createElement('div');
                card.className = "card d-flex justify-content-center align-items-center";
                card.textContent = "Ошибка при отправке запроса";
                div.append(card);
            }

        }
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(data));
    }

    $( document ).ready(function () {
        document.querySelector('#simple-search-courses-form').addEventListener('submit', function (e) {e.preventDefault();});
        document.querySelector('#advanced-search-courses-form').addEventListener('submit', function (e) {e.preventDefault();});
    });
</script>
{% endblock %}